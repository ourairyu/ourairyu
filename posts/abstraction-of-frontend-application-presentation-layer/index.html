<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>我来聊聊前端应用表现层抽象</title> <meta property="og:title" content="我来聊聊前端应用表现层抽象"> <meta name="description" content="在一个复杂的前端应用中，如果不对其进行分层，那它的扩展性和可维护性等真的会不忍直视……"> <meta property="og:description" content="在一个复杂的前端应用中，如果不对其进行分层，那它的扩展性和可维护性等真的会不忍直视……"> <meta name="keywords" content="软件工程,软件架构,前端开发,前端工程,前端架构"> <link rel="canonical" href="https://ourai.ws/posts/abstraction-of-frontend-application-presentation-layer/"> <meta property="og:url" content="https://ourai.ws/posts/abstraction-of-frontend-application-presentation-layer/"> <meta property="og:site_name" content="欧雷流"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "欧雷流", "url" : "https://ourai.ws" } </script> <meta property="og:image" content="https://ourai.ws/assets/posts/20200901/banner-6a4b4a9a265d37a7b6de0615315f9059b134f15fe30a7d9008f94888da3855f9.jpg"> <meta property="og:type" content="article"> <meta property="article:published_time" content="2020-09-01T23:42:35+08:00"> <link rel="next" href="https://ourai.ws/posts/the-core-concepts-of-frontend-ui-components/" title="聊聊前端 UI 组件：核心概念"> <link rel="prev" href="https://ourai.ws/posts/the-real-world/" title="客观的现实世界"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "我来聊聊前端应用表现层抽象", "image": "/assets/posts/20200901/banner-6a4b4a9a265d37a7b6de0615315f9059b134f15fe30a7d9008f94888da3855f9.jpg", "datePublished": "2020-09-01T23:42:35+08:00", "description": "在一个复杂的前端应用中，如果不对其进行分层，那它的扩展性和可维护性等真的会不忍直视……" } </script> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "person", "name" : "欧雷流", "url" : "https://ourai.ws", "sameAs" : null } </script> <link rel="author" href="https://ourai.ws"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <!-- 订阅 --> <link type="application/atom+xml" rel="alternate" href="https://ourai.ws/atom.xml" title="欧雷流" /> <link type="application/rss+xml" rel="alternate" href="//ourai.ws/rss.xml" title="欧雷流"> <meta name="theme-color" content="#0871ab"> <link rel="icon" href="/assets/favicon-3e749ca030e3b71eb2662d947c789061d2da9e0f4ee5f3360cfa9ccbe053c8ba.ico"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/disqusjs.min-b077139304675330d06888b873bd88158951637593a3c17c4674bc855caf71af.css"> <link type="text/css" rel="stylesheet" href="/assets/global-b623500154e70cdef18bd463a0ef409c46da6d1ad99756cf169ddb354874bcbc.css"> <link type="text/css" rel="stylesheet" href="/assets/share-2811f36e337fef8021089414f657904b7e88db17d8ecade0688c8c3f5e632a5c.css"> <link type="text/css" rel="stylesheet" href="/assets/pages/post-d5f1244d69bfc31e3c7b73b16140ed8a09f0b5af40515abeae522bee80e92ec9.css"> <script type="text/javascript" src="/assets/statistic-ae0fea4509b55747b1bcc6318c58abf5817e03e26505a307f438b42f0c6783bc.js"></script> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page has-headerImage" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">切换导航</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a href="/" class="navbar-brand" title="回到首页">Ourai.WS</a> </div> <!-- 导航 --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class="dropdown"> <a class="dropdown-toggle" href="/works/" data-toggle="dropdown">创作 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/posts/">文章</a></li> <li><a href="/videos/">视频</a></li> <li class="divider"></li> <li><a href="/moments/murmur/">想法</a></li> <li><a href="/notes/">笔记</a></li> <li><a href="https://s.ourai.ws/topics/weekly/?utm_source=ourai.ws&utm_medium=common-header" target="_blank" rel="external nofollow">周报</a></li> <li class="divider"></li> <li><a href="/answers/">问答</a></li> <li><a href="/open-source/">开源</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="/mine/" data-toggle="dropdown">我的 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/">计划</a></li> <li><a href="/people/">关系</a></li> <li class="divider"></li> <!-- 书影音 --> <li><a href="/publications/">读物</a></li> <li><a href="/dramas/">戏剧</a></li> <li class="divider"></li> <li><a href="/devices/">设备</a></li> <!-- <li><a href="#">Separated link</a></li> --> <!-- リア充 --> <li class="divider"></li> <li><a href="https://o.ourai.ws/?utm_source=ourai.ws&utm_medium=common-header" target="_blank" rel="external nofollow">生活</a></li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="/about/" data-toggle="dropdown">关于 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/about/">网站</a></li> <li><a href="https://linxoid.com/ourai/?utm_source=ourai.ws&utm_medium=common-header" target="_blank" rel="external nofollow">站长</a></li> <li class="divider"></li> <li><a href="/sponsor/">赞助</a></li> <li><a href="https://yaol.in/cooperation/?utm_source=ourai.ws&utm_medium=common-header" target="_blank" rel="external nofollow">合作</a></li> </ul> </li> <li><a href="/thanks/">致谢</a></li> </ul> </nav> </div> </div> </header> <main class="Page-content"> <!-- 页面横幅 --> <div class="Page-banner hidden-xs" style="background-image: url(/assets/posts/20200901/banner-6a4b4a9a265d37a7b6de0615315f9059b134f15fe30a7d9008f94888da3855f9.jpg);"> <figure class="sr-only"> <img src="/assets/posts/20200901/banner-6a4b4a9a265d37a7b6de0615315f9059b134f15fe30a7d9008f94888da3855f9.jpg" alt="Multi-device"> <figcaption>Multi-device</figcaption> </figure> </div> <!-- 内容主体 --> <div class="container"> <article class="Page-main Article"> <header class="Article-header"> <h1 class="Article-title">我来聊聊前端应用表现层抽象</h1> <p><a href="https://linxoid.com/ourai/" target="_blank" rel="external nofollow">欧雷</a> 发表于 <time datetime="2020-09-01T23:42:35+08:00">2020-09-01 23:42:35</time></p> <p class="Article-commentCount"><i class="fa fa-comments"></i><a href="#disqus_thread" data-disqus-identifier="/posts/abstraction-of-frontend-application-presentation-layer/">0 条评论</a></p> <p class="Article-tags hidden-xs"><i class="fa fa-tags"><span class="sr-only">标签：</span></i><a class="Article-tag" href="/tags/software-engineering/">软件工程</a><a class="Article-tag" href="/tags/software-architecture/">软件架构</a><a class="Article-tag" href="/tags/frontend-web-development/">前端开发</a><a class="Article-tag" href="/tags/frontend-engineering/">前端工程</a><a class="Article-tag" href="/tags/frontend-architecture/">前端架构</a></p> </header> <div class="Article-content col-md-9"> <p>我们处于变化很快的时代，无论是商业还是科技。一家公司看上去商业很成功，也许前脚刚上市，后脚就因为什么而退市，甚至倒闭；一项看似高大上的技术横空出世，各类媒体争先恐后地撰文介绍，热度炒得老高，没准没多久就出现了竞争者、替代者。</p> <p>在这样的大环境下，传统的「web 前端开发」演变成了「泛客户端开发」，前端开发者从「配置工程师」被「逼」成了「软件工程师」。开发变得更复杂了，要处理的问题更多了，从业难度不知提升了多少倍——前端早就不再简单。</p> <p>在众多必须要处理的问题中的一个，就是表现层运行环境的兼容问题，像跨浏览器和跨端、平台、技术栈。注意，这里说的是「表现层」而不是「视图层」。</p> <h2 id="section">「表现层」与「视图层」</h2> <p>「表现层」的英文是「presentation tier」或「presentation layer」，具体是哪个取决于是物理上还是逻辑上划分；而「视图层」的英文是「view」。「表现层」是「视图层」的超集，根据前端应用的架构设计，它们既可以不等又可以相等。</p> <h3 id="section-1">表现层</h3> <p>「表现层」这个词出自经典的三层架构（或多层架构），是其中一个分层。三层架构包括数据层、逻辑层和表现层，一般用在 C/S 架构中。</p> <figure> <img src="/assets/posts/20200901/three-tier-application-864edde12b184b210c5e34cf7c37c38ff35cc5db1760ccfa3f067607ad98a5f8.png" alt="三层架构" /> <figcaption>三层架构</figcaption> </figure> <p>为什么会在这篇讲前端开发的文章中提到它？这是因为，虽然在一些前端应用中用不到，尤其是快餐式应用，但在企业级复杂前端应用中就十分需要一个前端的「三层架构」。</p> <h3 id="section-2">视图层</h3> <p>「视图层」则来自表现层常用的「model-view-whatever」模式中的「view」，即「视图」。至于说的时候在「视图」后面加个「层」字合不合适，就不在这里讨论了，文中皆使用「视图层」这个词。</p> <h2 id="section-3">运行环境兼容</h2> <h3 id="section-4">跨浏览器</h3> <p>由于各浏览器厂商对标准实现的不一致以及浏览器的版本等原因，会导致特性支持不同、界面显示 bug 等问题的出现。但庆幸的是，他们基本是按照标准来的，所以在开发时源码的语法几乎没什么不同。</p> <p>所谓的「跨浏览器」实际上就是利用浏览器额外的私有特性和技术或辅以 JS 对浏览器的 bug 进行「修正」与功能支持。</p> <h3 id="section-5">跨端、平台、技术栈</h3> <p>现在，绝大部分的前端开发者是在做泛客户端开发——开发 web 应用、客户端应用和各类小程序。</p> <p>在做 web 应用时需要考虑 PC 端和移动端是分开还是适配？技术选型是用 React、Vue？还是用 Web Components？或是用其他的？做客户端应用、各类小程序时这些也会面临技术选型的问题。</p> <p>如果公司某个业务的功能覆盖了上述所有场景，该如何去支撑？与跨浏览器不同的是，不同端、平台、技术栈的源码语法不一样，要满足业务需求就得各开发一遍。然而，这显然成本过高，并且风险也有些大。</p> <p>那么，要怎么解决这个问题呢？从源头出发。根本的源头是业务场景，然后是产品设计，但这些都不是开发人员可掌控的，几乎无法改变。能够完全被开发人员所左右的基本只有开发阶段的事情，那就从这个阶段的源头入手——源码编写。</p> <p>若是与业务相关的代码只需编写一次就能运行在不同的端、平台、技术栈上，那真是太棒了！这将会大大地降低成本并减少风险！</p> <h2 id="section-6">表现层的抽象</h2> <p>为了达到跨端、平台、技术栈的目的，需要将表现层再划分为抽象层、运行层和适配层。其中，抽象层是为了统一源码的编写方式，可以是 DSL、配置等，它是一种协议或约定；运行层就是需要被「跨」的端、平台、技术栈；适配层则是将抽象层的产物转换为运行层正常运行所需要的形式。</p> <p>表现层中可以被抽象的大概有视图结构、组件外观、组件行为等。</p> <h3 id="section-7">视图结构</h3> <p>在 web 前端开发中，HTML 就是一种视图结构的抽象，描述了界面中都有什么，以及它们之间的层级关系。最终的显示需要浏览器解析 HTML 后调用操作系统的 GUI 工具库。</p> <p>对于业务支撑来说，无论是 HTML 还是其他什么拼凑界面的方式，相对来说比较低级（是「low level」而不是「low」），视图单元的划分粒度比较细，在开发界面时就会花费更多的时间。</p> <p>我们需要一种能够屏蔽一些不必关注的细节的视图结构抽象，在这个抽象中，每个视图单元都有着其在业务上的意义，而不是有没有都可以的角色。具体做法请看下文。</p> <h3 id="section-8">组件外观</h3> <p>大部分已存在的组件的视觉呈现是固定的，即某个组件的尺寸、形状、颜色、字体等无法被定制。如果同样的交互只是因为视觉上有所差异就要重新写组件，或者在组件外部重新写份样式进行覆盖，那未免也太痛苦了……</p> <p>我们可以将那些希望能够被定制的视觉呈现抽象成「主题」的一部分，这部分可以被叫做「皮肤」。在进行定制时，分为线下和线上两种方式。</p> <p>「线下」是指在应用部署前的开发阶段进行处理。在前端构建工具丰富的现在，写页面样式时已经不会去直接写 CSS，而是像 Sass 这种可编程式的预处理器。这样就可以抽取出一些控制视觉呈现的 Sass 变量，需要定制时通过在外部对变量赋值进行覆盖，而不需要费劲重写组件或样式。</p> <p>「线上」则是部署后根据运行时数据动态改变。在皮肤定制即时预览和低代码平台等场景，是基本没机会去修改 Sass 变量并走一遍构建流程的，即使技术上能够办到。借助 CSS 自定义属性（CSS 变量）的力量可以较为方便地做到视觉呈现的运行时变更。</p> <h3 id="section-9">组件行为</h3> <p>组件除了外观，其行为也应当是可以定制的。看到「行为」这个词，第一反应就是跟用户操作相关的事情，然而这里还包括与组件内部结构相关的。</p> <p>对于组件的外部来说，组件内部就是个黑盒子，其自身结构的组成部分有的可以被上文所说的视图结构所控制，有的则无能为力：</p> <figure> <img src="/assets/posts/20200901/search-component-ab203b331bfbec7e5ceaf0228a1b23fe07d3d8f695f131f9b5224de91dd0d3c9.jpg" alt="搜索组件" /> <figcaption>搜索组件</figcaption> </figure> <p>上图是一个比较复杂的搜索组件，虽然外观和布局看起来有所不同，但「它们」确实是同一个组件。外观不同的解决方案上面已经大体说明，这类视图结构无法控制的布局问题，需要枚举场景后在组件内进行支持，然后作为「主题」的一部分存在。</p> <p>跟用户操作相关的行为有组件自身的交互规则及与业务逻辑的结合这两类。</p> <p>交互规则又有两种：一种是像表单是在字段值发生改变时就校验还是在点击按钮时校验这样；另一种是像字段值是在输入框的值改变（<code>input</code> 事件）时更新还是失焦（<code>change</code> 事件）时更新这样，或是像下拉菜单的弹出层是在悬停（<code>hover</code> 事件）时出现还是点击（<code>click</code> 事件）时出现这样。</p> <p>前者的解决方式与上面说的视图结构无法控制的布局问题差不多，后者则是需要组件支持事件映射，即外部可以指定组件某些交互的触发事件。当然，这两者同样也可以作为「主题」的一部分。</p> <p>我们在写组件时有件事是需要极力避免却往往难以避免——组件中耦合业务逻辑。组件决定的应该只是外貌与交互形态，里面只有交互逻辑及控制展现的状态，不应该牵扯到任何具体业务相关的逻辑。只要长得一样、操作一样，那么就应该是同一个组件，具体业务相关的逻辑注入进去。</p> <p>这段十分「个性化」的业务逻辑，说白了就是响应用户操作的变化以及业务数据的变化去更改组件内部的状态：</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="p">{</span>
  <span class="c1">// 组件事件</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// 组件的一个点击事件</span>
    <span class="s1">&#39;click-a&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
    <span class="c1">// 组件的另一个点击事件</span>
    <span class="s1">&#39;click-b&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
    <span class="c1">// 组件的一个改变事件</span>
    <span class="s1">&#39;change-c&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{},</span>
  <span class="p">},</span>
  <span class="c1">// 业务数据变化的回调</span>
  <span class="nx">watch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">contextValue</span> <span class="p">)</span> <span class="p">{},</span>
<span class="p">}</span></code></pre></figure> <p>运行时会注入一个上下文给上述对象方法的 <code>this</code>，组件还可以添加工具方法给上下文。该上下文的内置属性与方法有：</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">interface</span> <span class="nx">IDomainSpecificComponentContext</span> <span class="p">{</span>
  <span class="nx">getState</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">any</span><span class="p">;</span>
  <span class="nx">setState</span><span class="p">(</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span><span class="o">:</span> <span class="ow">void</span><span class="p">;</span>
  <span class="nx">setState</span><span class="p">(</span><span class="nx">stateMap</span><span class="o">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span> <span class="p">})</span><span class="o">:</span> <span class="ow">void</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure> <h2 id="section-10">视图结构描述</h2> <p>上面说了我们需要一种比 HTML 之类的更进一步的视图结构抽象，下面就来说说这部分的大体思路。</p> <h3 id="section-11">技术选型</h3> <p>在做视图结构抽象时最常用到的技术就是 XML-based 或 XML-like 以及 JSON-based 的某种技术。XML-base 和 XML-like 的技术都是符合 XML 语法的，唯一的区别是前者要完全符合 XML 的标准规范，像 Angular 和 Vue 的模板就是后者；同样的，JSON-based 的技术是完全符合 JSON 的标准规范的技术，像 JSON Schema。</p> <p>自从 React 问世以来，其带来的 XML-like 的 JSX 也会被用于视图结构抽象，但基本仅限于编辑时（edit time）。一段 JSX 代码并不是纯声明式的，作为视图结构描述来说可读性较低，解析难度较高，并且通用性很低。</p> <p>JSON-based 的技术对前端运行时最为友好，解析成本几乎为零；相反的，其可读性很低，JSON 结构是纵向增长的，指定区域内的表达力十分受限，无法很直观地看出层级关系与视图单元的属性：</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="p">{</span>
  <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
  <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;form&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;children&quot;</span><span class="o">:</span> <span class="p">[{</span>
    <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;基本信息&quot;</span><span class="p">,</span>
      <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;fieldset&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;children&quot;</span><span class="o">:</span> <span class="p">[{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;姓名&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;input&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;gender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;性别&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;radio&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;年龄&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;number&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;birthday&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;生日&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;date-picker&quot;</span>
      <span class="p">}</span>
    <span class="p">}]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;宠物&quot;</span><span class="p">,</span>
      <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;fieldset&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;children&quot;</span><span class="o">:</span> <span class="p">[{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;dogs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;🐶&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;select&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;tag&quot;</span><span class="o">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span>
      <span class="s2">&quot;attrs&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;cats&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="o">:</span> <span class="s2">&quot;🐱&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="o">:</span> <span class="s2">&quot;select&quot;</span>
      <span class="p">}</span>
    <span class="p">}]</span>
  <span class="p">}]</span>
<span class="p">}</span></code></pre></figure> <p>如果一个应用的设计是不需要人工写视图结构描述的话，可以考虑使用 JSON-based 的技术。</p> <p>像 Angular 和 Vue 的模板那种 XML-like 的技术是相对来说最适合做视图结构描述的——纯声明式，结构是向水平与垂直两个方向增长，无论是可读性还是表达力都更强，解析难度适中，并且具备通用性。</p> <p>下面的模板代码所描述的内容与上面那段 JSON 代码一模一样，深呼吸，好好感受一下两者之间的差异：</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;view</span> <span class="na">widget=</span><span class="s">&quot;form&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;group</span> <span class="na">title=</span><span class="s">&quot;基本信息&quot;</span> <span class="na">widget=</span><span class="s">&quot;fieldset&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">label=</span><span class="s">&quot;姓名&quot;</span> <span class="na">widget=</span><span class="s">&quot;input&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;gender&quot;</span> <span class="na">label=</span><span class="s">&quot;性别&quot;</span> <span class="na">widget=</span><span class="s">&quot;radio&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;age&quot;</span> <span class="na">label=</span><span class="s">&quot;年龄&quot;</span> <span class="na">widget=</span><span class="s">&quot;number&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;birthday&quot;</span> <span class="na">label=</span><span class="s">&quot;生日&quot;</span> <span class="na">widget=</span><span class="s">&quot;date-picker&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/group&gt;</span>
  <span class="nt">&lt;group</span> <span class="na">title=</span><span class="s">&quot;宠物&quot;</span> <span class="na">widget=</span><span class="s">&quot;fieldset&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;dogs&quot;</span> <span class="na">label=</span><span class="s">&quot;🐶&quot;</span> <span class="na">widget=</span><span class="s">&quot;select&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;cats&quot;</span> <span class="na">label=</span><span class="s">&quot;🐱&quot;</span> <span class="na">widget=</span><span class="s">&quot;select&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/group&gt;</span>
<span class="nt">&lt;/view&gt;</span></code></pre></figure> <p>至此，视图结构描述最终该选用哪种技术，想必无须多言。</p> <figure> <img src="/assets/posts/20200901/xiaoji-f09d51b2400024bad15904d23fbcec8757a2532f68bd16f8eac4c1abe4428601.png" alt="鸡哥（小鸡）" /> <figcaption>鸡哥（小鸡）</figcaption> </figure> <h3 id="section-12">设计思路</h3> <p>毋庸置疑，模板的语法要符合 XML 语法是前提，再在此基础上根据需求进行定制、扩展。首先要定义标签集。所谓的「标签集」就是一个元素库，其中的每个元素都要具备一定语义，使其在业务上有存在意义。然后是制定描述元素的 schema 并实现其对应的解析、校验等逻辑。</p> <p>元素 schema 大概是长这样：</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="c1">// 属性值类型</span>
<span class="nx">type</span> <span class="nx">PropType</span> <span class="o">=</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">|</span> <span class="s1">&#39;number&#39;</span> <span class="o">|</span> <span class="s1">&#39;string&#39;</span> <span class="o">|</span> <span class="s1">&#39;regexp&#39;</span> <span class="o">|</span> <span class="s1">&#39;json&#39;</span><span class="p">;</span>

<span class="c1">// 属性描述符</span>
<span class="nx">type</span> <span class="nx">PropDescriptor</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">type</span><span class="o">:</span> <span class="nx">PropType</span> <span class="o">|</span> <span class="nx">PropType</span><span class="p">[];</span>
  <span class="nx">required</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// 是否必需</span>
<span class="p">};</span>

<span class="c1">// 元素 schema</span>
<span class="nx">type</span> <span class="nx">ElementSchema</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span> <span class="c1">// 元素名</span>
  <span class="nx">tag</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span> <span class="c1">// 标签名，不指定时取元素名</span>
  <span class="nx">props</span><span class="o">?:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">PropDescriptor</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">attrs</span><span class="o">?:</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="o">:</span> <span class="p">(</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">val</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">any</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="c1">// 节点行为，是作为父节点的子节点还是属性存在</span>
  <span class="nx">behavior</span><span class="o">?:</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;append&#39;</span> <span class="o">|</span> <span class="s1">&#39;attach&#39;</span><span class="p">;</span>
    <span class="c1">// 以下都用于 `type` 是 `&#39;attach&#39;` 时</span>
    <span class="nx">host</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span> <span class="c1">// 宿主（属性名）</span>
    <span class="nx">keyed</span><span class="o">?:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// 是否为键值对集合，值为 `true` 且 `merge` 为 `false` 时以节点 ID 为键</span>
    <span class="nx">merge</span><span class="o">?:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// 当值为 `true` 时将 `reduce` 的返回值与 `host` 指定的属性的值进行合并后重新赋值给 `host`</span>
    <span class="nx">reduce</span><span class="o">?:</span> <span class="p">(</span><span class="nx">node</span><span class="o">:</span> <span class="nx">ITemplateNode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">any</span><span class="p">;</span> <span class="c1">// 转换节点信息</span>
    <span class="nx">restore</span><span class="o">?:</span> <span class="p">(</span><span class="nx">reduced</span><span class="o">:</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">node</span><span class="o">?:</span> <span class="nx">ITemplateNode</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">ITemplateNode</span> <span class="o">|</span> <span class="nx">Partial</span><span class="o">&lt;</span><span class="nx">ITemplateNode</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span></code></pre></figure> <p>可以看到 schema 中有 <code>props</code> 和 <code>attrs</code>，它们共同组成了模板元素的属性（XML attributes），区别是：模板解析后的属性如果是在 <code>props</code> 中定义的并且满足属性描述符的 <code>type</code> 和 <code>required</code> 所指定的限制条件，会成为模板节点的 <code>props</code> 属性；剩余没在 <code>props</code> 中定义的则成为模板节点的 <code>attrs</code> 属性，通过 <code>resolve</code> 方法能够对属性根据自己的规则进行值的转换。</p> <p>虽然在模板中元素总是以嵌套的形式展示出层级关系，但一个元素并不一定就是其父级的结构，还可能是配置。因此，元素 schema 中的 <code>behavior</code> 用于设置当前元素在模板解析后是作为一个节点的子节点存在还是作为某个属性存在。</p> <p>上述的模板设计是纯视图结构描述的，并且只对元素这种「块」进行处理，我认为这样够用了。根据情况，可以扩展为像 Angular 和 Vue 的模板那样支持文本、插值和指令等。</p> <p>如果懒癌发作并且没什么特殊需求，模板解析的工作可以交给魔改后的 Vue 2.6 编译器，再适配为模板节点树。</p> <p>每个模板节点的结构大致为：</p> <figure class="highlight"><pre><code class="language-js" data-lang="js"><span></span><span class="kr">interface</span> <span class="nx">ITemplateNode</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">tag</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">attrs</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">key</span><span class="o">:</span> <span class="nx">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nx">parent</span><span class="o">:</span> <span class="nx">ITemplateNode</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nx">children</span><span class="o">:</span> <span class="nx">ITemplateNode</span><span class="p">[];</span>
<span class="p">}</span></code></pre></figure> <p>最后，通过适配层将模板节点树转为运行层的组件树，并把渲染的控制权也转交给了最终的运行环境。</p> <h2 id="section-13">总结</h2> <p>在一个复杂的前端应用中，如果不对其进行分层，那它的扩展性和可维护性等真的会不忍直视……通常是采用经典的三层架构，从下到上分别为数据层、逻辑层和表现层。本文以表现层为例，将其再次划分出抽象层、运行层和适配层这三层，实际上数据层和逻辑层也可以套用这种模式——就像在生日蛋糕上切上四刀——我称其为「九宫格」模型。</p> <figure> <img src="/assets/posts/20200901/architecture-model-55e34d8de4f8b47757b7d564d7538f62f3890cd064608850bf55e54f882aadfe.jpg" alt="「九宫格」模型" /> <figcaption>「九宫格」模型</figcaption> </figure> <p>在表现层的各种抽象中，本文着重阐述了视图结构描述的技术选型与设计思路，可以看出 XML-like 的模板从编写到解析再到渲染这一整条流程，与 Angular 和 Vue 的模板及 HTML 大体上一致；其他抽象只是稍微提了提，以后有机会再展开来说。</p> <p>之前也写过几篇与模板相关的文章：从提效角度与「面向组件」做对比的《<a href="/posts/template-based-frontend-web-development/" target="_blank">我来聊聊面向模板的前端开发</a>》；从可定制性角度讲的《<a href="/posts/configuration-driven-frontend-web-development/" target="_blank">我来聊聊配置驱动的视图开发</a>》；从低代码平台的核心理念「模型驱动」出发的《<a href="/posts/model-driven-frontend-web-development/" target="_blank">我来聊聊模型驱动的前端开发</a>》。可以说，本文的内容是它们有关表现层描述的「根基」。</p> <p>无论一家公司是不是做低代码平台的，或者内部有没有低代码平台，都应该从表现层抽象出视图结构描述，至少要有如此意识。</p> <div class="Article-donation"> <div class="Article-donationDetail"> <p>创作不易，若本文给你提供了价值，还请不吝<span class="Article-donationCharge">为<a href="https://linxoid.com/ourai/" target="_blank" rel="external nofollow">欧雷</a>充电</span></p> <p><img src="/assets/qrcodes/pay/wechat/donation-e2e3575287a218b650a69211a6d5e9220f9ad0314b2e946edcdc62cffcefcbd9.jpg" width="120"><img src="/assets/qrcodes/pay/alipay/ourai-2492dcf9d66d7a690e0576aa38945ad96e656b370d176c0b087638e83105844d.jpg" width="120"></p> <p>左为<span style="color: #38a138">微信</span>，右为<span style="color: #4b5dfa">支付宝</span>；充电累计 <strong>¥88</strong> 以上可在付款时备注或<a href="mailto:ourairyu+donate@gmail.com" target="_blank" rel="external nofollow">邮件</a>告知昵称和需要被链接的网址，会列在「<a href="/sponsor/#current">赞助</a>」页。其他方式与具体规则请见「<a href="/sponsor/#donation">资助</a>」。</p> </div> </div></div> <footer class="Article-footer col-md-3"> <div class="Widget Article-category"> <div class="Widget-body"> <p><i class="fa fa-pencil"></i>发布在</p> <div> <h3><a href="/categories/web-development/">网站开发</a></h3> <p>利用网页程序语言等技术进行网站和网络应用的开发与维护</p> </div> </div> </div> <div class="Widget Article-author hidden-xs hidden-sm"> <a class="Widget-body Author" href="https://linxoid.com/ourai/" title="了解欧雷" target="_blank" rel="external nofollow"> <h3 class="Author-name">欧雷</h3> <p class="Author-intro">日本深度中毒的<strong>新四有青年</strong>、<span lang="en">C<i class="fa fa-coffee"></i>ffee L<i class="fa fa-heart"></i>ver</span>，<strong>多面玩家</strong>。</p> </a> </div> <div class="Widget Article-license"> <div class="Widget-body"> <p>本文采用知识共享<i class="fa fa-creative-commons"></i><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="external nofollow">署名-非商业性使用 4.0 国际</a>许可协议，可自由转载、引用，但需署名作者并注明文章出处且不能用于商业用途。</p> </div> </div> <div class="Widget Widget--share"> <div class="Widget-body"> <p>分享到<i class="fa fa-share-alt"></i></p> <div class="social-share" data-sites="wechat,weibo,twitter"></div> </div> </div> <div class="Widget Article-series"> <div class="Widget-body"> <p><strong>我来聊聊「X」</strong> 系列</p> <p>聊聊我对「X」的理解</p> <p>共有 <a href="/series/let-me-talk-about-x/">5</a> 篇文章，<a href="/series/let-me-talk-about-x/">前往围观 &gt;</a></p> </div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> <!-- 相邻文章 --> <nav class="Article-siblings LightBox col-md-9"> <ul> <li class="Sibling Sibling--previous"> <a href="/posts/the-real-world/" style="background-image: url('/assets/posts/20200702/banner-f407c701911f54e24877f55d8afd4a09dc929324258560e7faaf4a6f55618f16.jpg');"> <h3>客观的现实世界</h3> <p> 形而上者谓之道，形而下者谓之器。 《易经·系辞》</p> </a> </li> <li class="Sibling Sibling--next"> <a href="/posts/the-core-concepts-of-frontend-ui-components/" style="background-image: url('/assets/posts/20200925/banner-33a5d7b16e66fae4d0527c1792177a5a1e37a88d283545df54de2f8eb073a5eb.jpg');"> <h3>聊聊前端 UI 组件：核心概念</h3> <p>本文是一个文章系列的第一篇，主要说明几个基本概念以及所要探讨的目标主体，目的是统一认知上的「上下文」以尽量避免因信息不对称而造成理解障碍。</p> </a> </li> </ul> </nav> <!-- 评论区 --> <div class="Article-comments col-md-9"> <div id="disqus_thread"></div> <script type="text/javascript" src="/assets/disqusjs.min-4aa6c162858d0f13ecf2af9524ee286e764a5989b6c891b736e5a70e0a520522.js"></script> <script> var dsqjs = new DisqusJS({ shortname: 'ourairyu', siteName: '欧雷流', identifier: '/posts/abstraction-of-frontend-application-presentation-layer/', url: 'http://' + location.host + '/posts/abstraction-of-frontend-application-presentation-layer/', title: '我来聊聊前端应用表现层抽象', api: 'https://disqus.skk.moe/disqus/', apikey: 'Ht1OT36NinKAkkNd2l0goxrLqXDGMg1zJKWx7309PWDunyGh6jbjRt3JUmvgHSIn', admin: 'ourai', adminLabel: '鹳狸猿' }); </script> </div> </article> </div> </main> <footer class="Page-footer Footer"> <div class="container"> <div class="Footer-description"> <!-- 重要链接 --> <nav class="Footer-navs"> <ul> <li><a href="https://meta.ourai.ws/?utm_source=ourai.ws&utm_medium=common-footer" title="访问「欧雷宇宙」" target="_blank" rel="external nofollow"><span>@</span></a></li> <li><a href="/about/"><span>关于</span></a></li> <li><a href="/sponsor/"><span>赞助</span></a></li> <li><a href="/topics/"><span>专题</span></a></li> <li><a href="/projects/"><span>计划</span></a></li> <li><a href="/thanks/"><span>致谢</span></a></li> <li><a href="https://yaol.in/cooperation/?utm_source=ourai.ws&utm_medium=common-footer" target="_blank" rel="external nofollow"><span>合作</span></a></li> </ul> </nav> <!-- 网站版权 --> <div class="Footer-copyright"> <p>&copy; 2009-2025 <a href="/">欧雷流</a> 版权所有</p> <p>采用 <a href="http://jekyllrb.com" target="_blank" rel="external nofollow">Jekyll</a> 生成 ♥ 版本为 <span title="构建于 2025-02-28 07:36">v3046f1b</span></p> </div> <div class="Footer-licenses"> <p><a href="http://beian.miit.gov.cn" target="_blank" rel="external nofollow">浙ICP备16006930号-1</a></p> <p><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602005556" target="_blank" rel="external nofollow">浙公网安备 33010602005556号</a></p> </div> <!-- 社交网站 --> <div class="Footer-links hidden-xs"> <ul> <li class="Icon Icon--email"><a href="mailto:ourairyu@gmail.com" title="发送邮件给我" target="_blank" rel="external nofollow">ourairyu@gmail.com</a></li> <li class="Icon Icon--gh"><a href="https://github.com/ourai" title="查看我的全部开源项目" target="_blank" rel="external nofollow">GitHub</a></li> <li class="Icon Icon--zh"><a href="https://www.zhihu.com/people/ourai" target="_blank" rel="external nofollow">知乎</a></li> </ul> </div> </div> </div> </footer> <script type="text/javascript" src="/assets/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/components-a266f21fe1dfd61bebf40e74872cbf901eb3e201f7d33e9e5d5af9a55f4b24ea.js"></script> <script type="text/javascript" src="/assets/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script><script type="text/javascript" src="/assets/initializers/lazyload-44b7df8a9282d598284d522e64d6be9ac88d466f3c4a734a514303e99347b2c9.js"></script> </body> </html>
